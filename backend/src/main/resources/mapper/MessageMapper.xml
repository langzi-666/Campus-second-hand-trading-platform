<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.campus.trade.mapper.MessageMapper">
    
    <!-- 结果映射 -->
    <resultMap id="BaseResultMap" type="com.campus.trade.entity.Message">
        <id column="id" property="id" />
        <result column="sender_id" property="senderId" />
        <result column="receiver_id" property="receiverId" />
        <result column="product_id" property="productId" />
        <result column="order_id" property="orderId" />
        <result column="type" property="messageType" />
        <result column="content" property="content" />
        <result column="image_url" property="imageUrl" />
        <result column="is_read" property="isRead" />
        <result column="created_at" property="createdAt" />
        <result column="updated_at" property="updatedAt" />
    </resultMap>
    
    <!-- 分页查询会话消息 -->
    <select id="selectConversationMessages" resultMap="BaseResultMap">
        SELECT * FROM messages 
        WHERE ((sender_id = #{userId1} AND receiver_id = #{userId2}) 
               OR (sender_id = #{userId2} AND receiver_id = #{userId1}))
        <if test="productId != null">
            AND product_id = #{productId}
        </if>
        ORDER BY created_at ASC
    </select>
    
    <!-- 获取用户的会话列表 -->
    <select id="selectUserConversations" resultMap="BaseResultMap">
        SELECT m1.* FROM messages m1
        INNER JOIN (
            SELECT 
                CASE 
                    WHEN sender_id = #{userId} THEN receiver_id 
                    ELSE sender_id 
                END AS other_user_id,
                product_id,
                MAX(created_at) AS max_time
            FROM messages 
            WHERE sender_id = #{userId} OR receiver_id = #{userId}
            GROUP BY other_user_id, product_id
        ) m2 ON ((m1.sender_id = #{userId} AND m1.receiver_id = m2.other_user_id) 
                 OR (m1.sender_id = m2.other_user_id AND m1.receiver_id = #{userId}))
                AND m1.created_at = m2.max_time
                AND (m1.product_id = m2.product_id OR (m1.product_id IS NULL AND m2.product_id IS NULL))
        ORDER BY m1.created_at DESC
    </select>
    
    <!-- 标记消息为已读 -->
    <update id="markMessagesAsRead">
        UPDATE messages 
        SET is_read = 1 
        WHERE receiver_id = #{receiverId} 
          AND sender_id = #{senderId}
          AND is_read = 0
        <if test="productId != null">
            AND product_id = #{productId}
        </if>
    </update>
    
    <!-- 统计未读消息数量 -->
    <select id="countUnreadMessages" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM messages 
        WHERE receiver_id = #{userId} AND is_read = 0
    </select>
    
    <!-- 获取两个用户之间的最新消息 -->
    <select id="selectLatestMessage" resultMap="BaseResultMap">
        SELECT * FROM messages 
        WHERE ((sender_id = #{userId1} AND receiver_id = #{userId2}) 
               OR (sender_id = #{userId2} AND receiver_id = #{userId1}))
        <if test="productId != null">
            AND product_id = #{productId}
        </if>
        ORDER BY created_at DESC 
        LIMIT 1
    </select>
    
</mapper>
